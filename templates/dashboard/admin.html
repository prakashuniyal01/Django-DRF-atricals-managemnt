<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css"
    rel="stylesheet" />
  <style>
    .profile-cart {
      position: absolute;
      top: 50px;
      right: 10px;
      width: 300px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
      padding: 15px;
      display: none;
      z-index: 999;
    }

    .profile-cart img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 15px;
    }

    #profile-icon {
      border-radius: 50%;
      width: 40px;
      height: 40px;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <button class="btn btn-primary me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar"
          aria-controls="sidebar">
          <i class="bi bi-list"></i>
        </button>
        <h4>Welcome, <span id="user-name"></span></h4>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
            <li class="nav-item">
              <a class="nav-link" href="/articles">Articles</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="profile-icon-link">
                <img src="https://via.placeholder.com/40" id="profile-icon" alt="Profile Icon" />
              </a>
              <div class="profile-cart" id="profile-cart">
                <div class="profile-header">
                  <img src="https://via.placeholder.com/50" id="profile-image" alt="Profile Image" />
                  <h5 id="user-name-dropdown"></h5>
                </div>
                <ul class="profile-details">
                  <li>
                    <span>Email:</span> <span id="user-email-dropdown"></span>
                  </li>
                  <li>
                    <span>Phone:</span> <span id="user-phone-dropdown"></span>
                  </li>
                  <li>
                    <span>Role:</span> <span id="user-role-dropdown"></span>
                  </li>
                </ul>
                <button class="btn btn-danger btn-logout" id="logout-btn">
                  Logout
                </button>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <!-- Sidebar -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
    <div class="offcanvas-header">
      <h5 id="sidebarLabel">Menu</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <!-- User Profile Section -->
      <div id="user-profile" class="mb-3">
        <h6>Welcome, <span id="user-fullname">User</span></h6>
        <p>Email: <span id="user-email"></span></p>
        <p>Role: <span id="user-role"></span></p>
      </div>
      <ul class="list-group">
        <li class="list-group-item">
          <a href="#" data-bs-toggle="modal" data-bs-target="#profileModal">Profile Settings</a>
        </li>
        <li class="list-group-item">
          <a href="#" data-bs-toggle="modal" data-bs-target="#updateDetailsModal">Update Details</a>
        </li>
        <li class="list-group-item">
          <a href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">Change Password</a>
        </li>
        <li class="list-group-item">
          <a href="#" id="logout-sidebar">Logout</a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Modals -->

  <!-- Profile Modal -->
  <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="profileModalLabel">Profile Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Full Name:</strong> <span id="modal-fullname"></span></p>
          <p><strong>Email:</strong> <span id="modal-email"></span></p>
          <p><strong>Role:</strong> <span id="modal-role"></span></p>
          <p><strong>Number</strong> <span id="modal-number"></span></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Update Details Modal -->
  <div class="modal fade" id="updateDetailsModal" tabindex="-1" aria-labelledby="updateDetailsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateDetailsModalLabel">
            Update Details
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="update-user-form">
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" id="email" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="number" class="form-label">Phone Number</label>
              <input type="text" id="number" class="form-control" required />
            </div>
            <button type="submit" class="btn btn-primary">
              Save Changes
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="changePasswordModalLabel">
            Change Password
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="change-password-form">
            <div class="mb-3">
              <label for="old-password" class="form-label">Old Password</label>
              <input type="password" id="old-password" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="new-password" class="form-label">New Password</label>
              <input type="password" id="new-password" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="confirm-password" class="form-label">Confirm Password</label>
              <input type="password" id="confirm-password" class="form-control" required />
            </div>
            <button type="submit" class="btn btn-primary">
              Change Password
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Dashboard Content -->
  <main class="mt-4 container dashboard-container">
    <div class="banner text-center p-5" style="
          background: url('https://via.placeholder.com/1200x400') no-repeat
            center/cover;
          color: #fff;
        ">
      <h1>Welcome</h1>
      <p class="lead">Discover, read, and manage articles seamlessly.</p>
      <a href="#articles-container" class="btn btn-primary btn-lg">Explore Articles</a>
    </div>
  </main>
  <!-- Main container for the user list -->
<div class="container mt-5">
  <h1 class="text-center mb-4">User List</h1>

  <div id="user-list">
      <!-- User data will be dynamically inserted here -->
  </div>

  <!-- Update User Modal -->
  <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="updateModalLabel">Update User</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <form id="update-form">
                      <div class="mb-3">
                          <label for="full-name" class="form-label">Full Name</label>
                          <input type="text" class="form-control" id="full-name" required>
                      </div>
                      <div class="mb-3">
                          <label for="email-modal" class="form-label">Email</label>
                          <input type="email" class="form-control" id="email-modal" required>
                      </div>
                      <div class="mb-3">
                          <label for="number-modal" class="form-label">Phone Number</label>
                          <input type="text" class="form-control" id="number-modal" required>
                      </div>
                      <div class="mb-3">
                          <label for="role" class="form-label">Role</label>
                          <select class="form-control" id="role" required>
                              <option value="journalist">Journalist</option>
                              <option value="editor">Editor</option>
                              <option value="admin">Admin</option>
                          </select>
                      </div>
                      <div class="mb-3">
                          <label for="is-active" class="form-label">Active Status</label>
                          <select class="form-control" id="is-active" required>
                              <option value="true">Active</option>
                              <option value="false">Inactive</option>
                          </select>
                      </div>
                      <div class="mb-3">
                          <label for="is-staff" class="form-label">Staff Status</label>
                          <select class="form-control" id="is-staff" required>
                              <option value="true">Staff</option>
                              <option value="false">Non-Staff</option>
                          </select>
                      </div>
                      <button type="submit" class="btn btn-primary">Update</button>
                  </form>
              </div>
          </div>
      </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Wait until the document content is fully loaded
    document.addEventListener("DOMContentLoaded", () => {
      // Retrieve the access token from localStorage to check if the user is authenticated
      const accessToken = localStorage.getItem("access_token");

      // If the token does not exist, redirect the user to the login page
      if (!accessToken) {
        redirectToLoginPage();
      } else {
        // If the token is present, fetch the user's data from the server
        fetchUserData(accessToken);
      }

      // Event listener to toggle the visibility of the profile dropdown menu
      document.getElementById("profile-icon-link").addEventListener("click", toggleProfileDropdown);

      // Event listeners to handle logout from both the main profile section and sidebar
      document.getElementById("logout-btn").addEventListener("click", logout);
      document.getElementById("logout-sidebar").addEventListener("click", logout);

      // Populate the sidebar and modals with user data after login
      populateSidebarAndModals();

      // Handle user update form submission for changing personal details (email and phone number)
      handleUserUpdateForm();

      // Handle password change form submission
      handleChangePasswordForm();
    });

    // **Redirect the user to the login page**  
    function redirectToLoginPage() {
      // Redirect to the login page if the user is not authenticated
      window.location.href = "/users/login-page";
    }

    // **Fetch user data using the access token**
    function fetchUserData(accessToken) {
      // Fetch user data from the server
      fetch("/users/user/", {
        method: "GET",
        headers: {
          Authorization: `Bearer ${accessToken}`, // Include the access token in the request headers
        },
      })
        .then(response => response.json()) // Parse the JSON response from the server
        .then(data => {
          if (data) {
            // If data is received, save it to localStorage and update the profile section
            saveUserDataToLocalStorage(data);
            updateProfileSection(data);
          } else {
            // If no data is received, alert the user
            alert("Failed to fetch user data");
          }
        })
        .catch((error) => {
          // If there's an error during the fetch process, log the error and alert the user
          console.error("Error:", error);
          alert("An error occurred while fetching user data.");
        });
    }

    // **Save the fetched user data to localStorage for future use**
    function saveUserDataToLocalStorage(data) {
      // Store the user data as a stringified JSON object in localStorage
      localStorage.setItem("user_data", JSON.stringify(data));
    }

    // **Update the profile section on the page with user data**
    function updateProfileSection(data) {
      // Update various elements on the page with the user's details (name, profile image, etc.)
      document.getElementById("user-name").textContent = data.full_name;
      document.getElementById("profile-icon").src = data.profile_image || "https://via.placeholder.com/40";
      document.getElementById("user-name-dropdown").textContent = data.full_name;
      document.getElementById("user-email-dropdown").textContent = data.email;
      document.getElementById("user-phone-dropdown").textContent = data.number;
      document.getElementById("user-role-dropdown").textContent = data.role;
    }

    // **Toggle the visibility of the profile dropdown**
    function toggleProfileDropdown() {
      const profileCart = document.getElementById("profile-cart");
      // Toggle the display property of the profile dropdown (show or hide)
      profileCart.style.display = profileCart.style.display === "block" ? "none" : "block";
    }

    // **Logout the user by clearing stored data and redirecting to login page**
    function logout() {
      // Remove user data and access token from localStorage
      localStorage.removeItem("user_data");
      localStorage.removeItem("access_token");
      // Redirect the user to the login page
      redirectToLoginPage();
    }

    // **Populate the sidebar and modals with user details**
    function populateSidebarAndModals() {
      // Retrieve the access token from localStorage to authenticate the request
      const token = localStorage.getItem("access_token");

      // Fetch user data to populate the sidebar and modals
      fetch("/users/user/", {
        method: "GET",
        headers: {
          Authorization: `Bearer ${token}`, // Pass the access token in the request headers
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json()) // Parse the response as JSON
        .then((data) => {
          if (data) {
            // If data is fetched successfully, update the sidebar and modal UI elements
            updateSidebar(data);
            updateModal(data);
            updateUpdateForm(data);
          }
        })
        .catch((error) => console.error("Error:", error)); // Log errors if the fetch fails
    }

    // **Update sidebar with user data**
    function updateSidebar(data) {
      // Populate sidebar with user's full name, email, and role
      document.getElementById("user-fullname").textContent = data.full_name;
      document.getElementById("user-email").textContent = data.email;
      document.getElementById("user-role").textContent = data.role;
    }

    // **Update modal with user data**
    function updateModal(data) {
      // Populate the modal with user's full name, email, role, and phone number
      document.getElementById("modal-fullname").textContent = data.full_name;
      document.getElementById("modal-email").textContent = data.email;
      document.getElementById("modal-role").textContent = data.role;
      document.getElementById("modal-number").textContent = data.number;
    }

    // **Populate the update form with the user's current data**
    function updateUpdateForm(data) {
      // Pre-fill the form fields with user's current email and phone number
      document.getElementById("email").value = data.email;
      document.getElementById("number").value = data.number || ""; // Default to an empty string if the phone number is null
    }

    // **Handle the user update form submission (for email and phone number updates)**
    function handleUserUpdateForm() {
      // Listen for the form submission
      document.getElementById("update-user-form").addEventListener("submit", (event) => {
        event.preventDefault(); // Prevent the default form submission behavior

        // Get the user ID from localStorage to update the correct user data
        const userId = JSON.parse(localStorage.getItem("user_data")).id;
        const updateApiUrl = `/users/user/${userId}/update/`; // Dynamic API endpoint based on user ID

        // Collect the form data (email and phone number)
        const userData = {
          email: document.getElementById("email").value,
          number: document.getElementById("number").value,
        };

        // Send a PUT request to update the user's details on the server
        updateUserDetails(updateApiUrl, userData);
      });
    }

    // **Send the PUT request to update the user's details**
    function updateUserDetails(updateApiUrl, userData) {
      // Retrieve the access token from localStorage for authentication
      const token = localStorage.getItem("access_token");

      // Send the PUT request to the API to update the user's data
      fetch(updateApiUrl, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(userData), // Send the updated user data in the request body
      })
        .then((response) => response.json()) // Parse the JSON response
        .then(() => {
          // Show an alert and reload the page after a successful update
          alert("Details updated successfully!");
          window.location.reload(); // Refresh the page to reflect changes
        })
        .catch((error) => {
          console.error("Error:", error); // Log any errors
          alert("An error occurred while updating the details."); // Show an error message
        });
    }

    // **Handle password change form submission**
    function handleChangePasswordForm() {
      // Listen for the form submission
      document.getElementById("change-password-form").addEventListener("submit", (event) => {
        event.preventDefault(); // Prevent the default form submission behavior

        // Collect the password change data (old password, new password, confirm new password)
        const passwordData = {
          old_password: document.getElementById("old-password").value,
          new_password: document.getElementById("new-password").value,
          confirm_password: document.getElementById("confirm-password").value,
        };

        // Send the password change request if the data is valid
        changePassword(passwordData);
      });
    }

    // **Send the password change request to the server**
    function changePassword(passwordData) {
      const token = localStorage.getItem("access_token");
      const apiUrl = "/users/change-password/";

      // Validate the password data before sending the request
      if (validatePasswordData(passwordData)) {
        fetch(apiUrl, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify(passwordData), // Send the password data in the request body
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((data) => {
                throw new Error(data.detail || "Failed to change password.");
              });
            }
            return response.json();
          })
          .then(() => {
            // Show a success message and reset the password form
            alert("Password changed successfully!");
            document.getElementById("change-password-form").reset();
          })
          .catch((error) => {
            console.error("Error:", error);
            alert(error.message || "An unknown error occurred.");
          });
      }
    }
    // Define the endpoint and retrieve the access token from localStorage
    const apiEndpoint = '/users/admin/users/';
const accessToken = localStorage.getItem("access_token");

// Fetch and display users
async function fetchUsers() {
    if (!accessToken) {
        alert("Access token not found. Please login.");
        return;
    }

    try {
        const response = await fetch(apiEndpoint, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`Error fetching users: ${response.statusText}`);
        }

        const users = await response.json();
        displayUsers(users);
    } catch (error) {
        console.error("Error fetching users:", error);
        alert("Failed to load user data. Please try again later.");
    }
}

// Display users in the list
function displayUsers(users) {
    const userListDiv = document.getElementById('user-list');
    userListDiv.innerHTML = '';  // Clear existing list

    if (users.length === 0) {
        userListDiv.innerHTML = '<p>No users found.</p>';
        return;
    }

    const ul = document.createElement('ul');
    ul.classList.add('list-group');

    users.forEach(user => {
        const li = document.createElement('li');
        li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
        
        li.innerHTML = `
            <div>
                <strong>${user.full_name}</strong><br>
                <small>Email: ${user.email}</small><br>
                <small>Role: ${user.role}</small><br>
                <small>Phone: ${user.number}</small>
            </div>
            <div>
                <span class="badge ${user.is_active ? 'bg-success' : 'bg-danger'}">${user.is_active ? 'Active' : 'Inactive'}</span>
                <span class="badge ${user.is_staff ? 'bg-info' : 'bg-secondary'}">${user.is_staff ? 'Staff' : 'Non-Staff'}</span>
                <button class="btn btn-warning btn-sm ms-2" onclick="openEditModal(${user.id})">Edit</button>
                <button class="btn btn-danger btn-sm ms-2" onclick="deleteUser(${user.id})">Delete</button>
            </div>
        `;

        ul.appendChild(li);
    });

    userListDiv.appendChild(ul);
}

// Open edit modal and load current user data
function openEditModal(userId) {
    fetch(`${apiEndpoint}${userId}/`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(user => {
        if (user) {
            document.getElementById('full-name').value = user.full_name;
            document.getElementById('email-modal').value = user.email;
            document.getElementById('number-modal').value = user.number;
            document.getElementById('role').value = user.role;
            document.getElementById('is-active').value = user.is_active.toString();
            document.getElementById('is-staff').value = user.is_staff.toString();
            document.getElementById('update-form').onsubmit = (e) => {
                e.preventDefault();
                updateUser(userId);
            };
            new bootstrap.Modal(document.getElementById('updateModal')).show();
        }
    })
    .catch(error => {
        console.error("Error loading user data for edit:", error);
        alert('Failed to load user data for editing.');
    });
}

// Update user data via PATCH request
function updateUser(userId) {
    const updatedData = {
        full_name: document.getElementById('full-name').value,
        email: document.getElementById('email-modal').value,
        number: document.getElementById('number-modal').value,
        role: document.getElementById('role').value,
        is_active: document.getElementById('is-active').value === 'true',
        is_staff: document.getElementById('is-staff').value === 'true'
    };

    fetch(`${apiEndpoint}${userId}/`, {
        method: 'PUT',  // Changed from PATCH to PUT
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Failed to update user: ${response.statusText}`);
        }
        return response.json();
    })
    .then(updatedUser => {
        alert('User updated successfully');
        fetchUsers();  // Re-fetch the user list
        new bootstrap.Modal(document.getElementById('updateModal')).hide();
    })
    .catch(error => {
        console.error("Error updating user:", error);
        alert('Failed to update user. Please try again.');
    });
}


// Delete user via DELETE request
function deleteUser(userId) {
    const confirmDelete = confirm("Are you sure you want to delete this user?");
    if (confirmDelete) {
        fetch(`${apiEndpoint}${userId}/`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to delete user: ${response.statusText}`);
            }
            alert('User deleted successfully');
            fetchUsers();  // Re-fetch the user list
        })
        .catch(error => {
            console.error("Error deleting user:", error);
            alert('Failed to delete user. Please try again.');
        });
    }
}

// Fetch users on page load
window.onload = fetchUsers;


  </script>
</body>

</html>